# 実践編⑤ GAS×チャットワークAPI連携

GASからチャットワークAPIを使って、通知を送信するツールを作成します。

**注意：この章はロードマップ外の上級者向けコンテンツです。**

---

## 🎯 この実践で学ぶこと

- チャットワークAPIの基本
- APIトークンの取得方法
- GASからチャットワークに通知を送信する方法
- 実用的な活用例

---

## 1. チャットワークAPIとは？

チャットワークは、ビジネスチャットツールとして広く使われているサービスです。チャットワークAPIを使うことで、GASから自動的にメッセージを送信できます。

### できること

- チャットワークにメッセージを自動送信
- タスクを自動作成
- ファイルをアップロード
- メンバー情報を取得

---

## 2. チャットワークAPIトークンの取得

チャットワークAPIを使用するには、**APIトークン**が必要です。

### 取得手順

1. **チャットワークにログイン**
2. **右上のアイコン → 「サービス連携」をクリック**
3. **「API Token」タブを選択**
4. **「新しいトークンを発行」をクリック**
5. **トークン名を入力（例：「GAS連携用」）**
6. **「作成」をクリック**
7. **表示されたAPIトークンをコピーして安全に保存**

⚠️ **注意：** APIトークンは、一度しか表示されません。必ずコピーして安全な場所に保存してください。

---

## 3. GASからチャットワークにメッセージを送信

### ステップ1：APIトークンをGASに保存

まず、APIトークンをGASの「プロパティサービス」に保存します。

```javascript
function setChatworkApiToken() {
  const scriptProperties = PropertiesService.getScriptProperties();
  scriptProperties.setProperty('CHATWORK_API_TOKEN', 'YOUR_API_TOKEN_HERE');
}
```

**手順：**
1. 上記のコードをGASエディタに貼り付け
2. `YOUR_API_TOKEN_HERE`を、実際のAPIトークンに置き換え
3. 関数を実行（初回のみ）

### ステップ2：ルームIDを取得

チャットワークでメッセージを送信するには、**ルームID**が必要です。

**ルームIDの確認方法：**
1. チャットワークで送信先のルームを開く
2. URLを確認：`https://www.chatwork.com/#!rid12345678`
3. `rid`の後の数字がルームID（例：`12345678`）

### ステップ3：メッセージ送信コードを作成

以下のコードで、チャットワークにメッセージを送信できます。

```javascript
function sendChatworkMessage() {
  // APIトークンを取得
  const scriptProperties = PropertiesService.getScriptProperties();
  const apiToken = scriptProperties.getProperty('CHATWORK_API_TOKEN');

  // ルームID（送信先のルーム）
  const roomId = '12345678'; // ここに実際のルームIDを入力

  // 送信するメッセージ
  const message = 'GASからの自動送信テストです！';

  // APIエンドポイント
  const url = `https://api.chatwork.com/v2/rooms/${roomId}/messages`;

  // リクエストオプション
  const options = {
    'method': 'POST',
    'headers': {
      'X-ChatWorkToken': apiToken
    },
    'payload': {
      'body': message
    }
  };

  // API呼び出し
  try {
    const response = UrlFetchApp.fetch(url, options);
    Logger.log('メッセージ送信成功: ' + response.getContentText());
  } catch (error) {
    Logger.log('エラー: ' + error.message);
  }
}
```

---

## 4. 実用的な活用例

### 例1：Googleフォーム回答時にチャットワークに通知

Googleフォームに回答があったら、チャットワークに通知を送信します。

**プロンプト例（ChatGPTに送る）：**

```
Google Apps Scriptで、以下の機能を持つツールを作成してください。

【やりたいこと】
Googleフォームに回答があったら、チャットワークに通知を送信する

【現在の手順】
1. Googleフォームで回答を受け取る
2. スプレッドシートに回答が記録される
3. チャットワークに以下の内容で通知を送信：
   「新しい問い合わせがありました！
   お名前：{お名前}
   内容：{お問い合わせ内容}」

【その他の要望】
- フォーム送信時に自動的に実行されるようにする
- チャットワークAPIトークンは、プロパティサービスから取得する
- ルームIDは「12345678」
```

### 例2：スプレッドシートの値が更新されたらチャットワークに通知

スプレッドシートの特定のセルが更新されたら、チャットワークに通知を送信します。

**プロンプト例（ChatGPTに送る）：**

```
Google Apps Scriptで、以下の機能を持つツールを作成してください。

【やりたいこと】
スプレッドシートの「在庫数」列が10以下になったら、チャットワークに通知を送信する

【現在の手順】
1. スプレッドシートが編集される
2. 「在庫数」列（D列）の値をチェック
3. 10以下の場合、チャットワークに通知を送信：
   「⚠️ 在庫が少なくなっています！
   商品名：{商品名}
   在庫数：{在庫数}」

【その他の要望】
- スプレッドシート編集時に自動的に実行されるようにする
- チャットワークAPIトークンは、プロパティサービスから取得する
- ルームIDは「12345678」
```

### 例3：定期的に売上レポートをチャットワークに送信

毎日決まった時間に、売上レポートをチャットワークに送信します。

**プロンプト例（ChatGPTに送る）：**

```
Google Apps Scriptで、以下の機能を持つツールを作成してください。

【やりたいこと】
毎日午前9時に、前日の売上レポートをチャットワークに送信する

【現在の手順】
1. スプレッドシートから前日の売上データを取得
2. 売上合計、注文件数を集計
3. チャットワークに以下の内容で送信：
   「📊 売上レポート（{前日の日付}）
   売上合計：{売上合計}円
   注文件数：{注文件数}件」

【その他の要望】
- 毎日午前9時に自動実行されるようにトリガーを設定
- チャットワークAPIトークンは、プロパティサービスから取得する
- ルームIDは「12345678」
```

---

## 5. チャットワークAPI連携の注意点

### 🔐 APIトークンの管理

APIトークンは、絶対に他人に見せてはいけません。プロパティサービスを使って安全に保存しましょう。

### 📊 API呼び出し回数の制限

チャットワークAPIには、**1時間あたり100回**の呼び出し制限があります。過度な呼び出しを避けましょう。

### 💬 メンション機能

チャットワークのメッセージでは、`[To:123456]`のように記述することで、特定のユーザーにメンションを送ることができます。

**例：**
```javascript
const message = '[To:123456] 新しい問い合わせがありました！';
```

---

## ✅ まとめ

この実践では、以下のことを学びました：

- チャットワークAPIトークンの取得方法
- GASからチャットワークにメッセージを送信する方法
- 実用的な活用例（フォーム通知、在庫アラート、売上レポート）

チャットワークAPI連携により、業務の通知や報告を自動化できます。ぜひ活用してみてください！
